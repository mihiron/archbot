box: wercker/default

build:
  steps:
    - script:
        name: empty
        code: echo 1

deploy:
  steps:
    - script:
        name: create .ssh directory
        code: mkdir -p "$HOME/.ssh"
    - create-file:
        name: write ssh key
        filename: $HOME/.ssh/id_rsa
        overwrite: true
        hide-from-log: true
        content: $WERCKER_SSH_KEY_PRIVATE
    - script:
        name: restart hubot
        code: |
          ssh $SSH_HOST "export HUBOT_SLACK_TOKEN=$HUBOT_SLACK_TOKEN && \
                         cd $HUBOT_DIR && \
                         git pull origin $WERCKER_GIT_BRANCH && \
                         ndenv exec node ~/node_modules/.bin/pm2 stop all && \
                         ndenv exec node ~/node_modules/.bin/pm2 start -f bin/hubot -x --name hubot -- -a slack -n archbot"
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_WEBHOOK_URL
